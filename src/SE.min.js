(function(){var ROOT=this;var SE_REVISION=1;var DEFAULT_TAB_NAME="Default";var GLOBAL_IDENTIFIER="__Global__";var LOCAL_STORAGE_SEDATA_KEY="__SE__";var DEFAULT_WORKER_INTERVAL=100;var DEFAULT_TAB_TIMEOUT_MULTIPLIER=2;var DEFAULT_STORAGE_LOCK_MULTIPLIER=2;var checksFailed=false;if(ROOT.__SE__!==undefined)checksFailed=true;if(!("localStorage"in window&&window["localStorage"]!==null))checksFailed=true;if(!ROOT.URL&&!ROOT.webkitURL)checksFailed=true;if(!ROOT.Blob&&!ROOT.BlobBuilder&&!ROOT.WebKitBlobBuilder&&!ROOT.MozBlobBuilder)checksFailed=true;if(!ROOT.Worker)checksFailed=true;if(checksFailed)return false;ROOT.URL=ROOT.URL||ROOT.webkitURL;var Blob=ROOT.Blob||false;var BlobBuilder=ROOT.BlobBuilder||ROOT.WebKitBlobBuilder||ROOT.MozBlobBuilder||false;(function(e){var t=e.clear;e.clear=function(){var n=e.getItem(LOCAL_STORAGE_SEDATA_KEY);t.apply(e,arguments);e.setItem(LOCAL_STORAGE_SEDATA_KEY,n)}})(ROOT.localStorage);var CheckType=function(e){if(e===undefined||!/^[a-zA-Z]*$/i.test(e.toString())){throw new Error("__SE__: event type should contains [a-zA-Z]. Type was sent: "+e)}else{return true}};var CheckTabName=function(e){if(e===undefined||!/^[a-zA-Z\_\-\d]*$/i.test(e.toString())){throw new Error("__SE__: tab name should contains [a-zA-Z_-d]. Name was sent: "+e)}else{return true}};var CheckListener=function(e){if(e===undefined||typeof e!=="function"){throw new Error("__SE__: listener should be a function. Type of listener was sent: "+typeof e)}else{return true}};var CheckCallback=function(e){if(e===undefined||typeof e!=="function"){throw new Error("__SE__: callback should be a function. Type of callback was sent: "+typeof e)}else{return true}};var GenerateID=function(){return"xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx".replace(/[x]/g,function(){return(Math.random()*16|0).toString(16)})};var CreateEvent=function(e,t,n){var t={Data:t,Sender:{Name:__SE__.Name,ID:__SE__.ID},Timestamp:(new Date).getTime()};var r={Type:e,Target:n,Data:t,Sender:{Name:__SE__.Name,ID:__SE__.ID},CheckedBy:__SE__.SelfExecution||n===__SE__.GID?[]:[__SE__.ID]};return r};var CreateTabData=function(e){var e=e||false;var t={Name:__SE__.Name,ID:__SE__.ID,Ping:(new Date).getTime(),Checked:e,ConfigCache:{Sync:__SE__.Sync,TabTimeoutMult:__SE__.TabTimeoutMult,SLockTimeoutMult:__SE__.SLockTimeoutMult}};return t};var UnpackSEData=function(e){var e=e||false;var t=localStorage.getItem(LOCAL_STORAGE_SEDATA_KEY);if(t===null&&e){return false}if(t!==null){var t=JSON.parse(t);if(e)return t;if(t.Lock!==0&&t.Lock+__SE__.Sync*__SE__.SLockTimeoutMult>(new Date).getTime()){return false}else{t.Lock=(new Date).getTime();PackSEData(t)}return t}else{t={SE_Revision:SE_REVISION,Config:{Sync:__SE__.Sync,TabTimeoutMult:__SE__.TabTimeoutMult,SLockTimeoutMult:__SE__.SLockTimeoutMult},Lock:(new Date).getTime(),Tabs:[CreateTabData()],EventsEmitted_Local:[],EventsEmitted_Global:[],SharedEventListeners:[]};PackSEData(t);return t}};var PackSEData=function(e){localStorage.setItem(LOCAL_STORAGE_SEDATA_KEY,JSON.stringify(e))};var GetConfig=function(){var e=UnpackSEData(true);return e!==false?e.Config:false};var CreateWebWorker=function(){var e=["var pingSEProcess = function(){",'postMessage( "ping" );',"};","setInterval( pingSEProcess , "+__SE__.Sync+" );",'onmessage = function(){ postMessage( "dead" ); close(); };'].join(" ");if(Blob){var t=new Blob([e],{type:"text/javascript"})}else{var t=new BlobBuilder;t.append(e);t=t.getBlob()}__SE__.Worker=new ROOT.Worker(ROOT.URL.createObjectURL(t));__SE__.Worker.onmessage=function(e){if(e.data==="ping"){SEWorker()}if(e.data==="dead"){CreateWebWorker()}}};var CheckTabs=function(e){var t=false;var n=[];var r=0;var i=e.Tabs;__SE__.ActiveTabsCount=__SE__.ActiveTabsCount?__SE__.ActiveTabsCount:i.length;for(var s=0,o=i.length;s<o;s++){var u=i[s].ConfigCache.Sync*__SE__.ActiveTabsCount*i[s].ConfigCache.TabTimeoutMult;if(i[s].ID===__SE__.ID){i[s].Ping=(new Date).getTime();i[s].Name=__SE__.Name;t=true}if(i[s].Ping+u>(new Date).getTime()){n.push(i[s])}else{__SE__.dispatchEvent("tabClosed",{Name:i[s].Name,ID:i[s].ID},__SE__.GID)}if(i[s].Checked===true){r++}}if(!t){var a=CreateTabData();__SE__.dispatchEvent("tabOpened",{Name:a.Name,ID:a.ID},__SE__.GID);n.push(a)}if(n.length===r){for(var s=0,o=n.length;s<o;s++){n[s].Checked=false}}__SE__.ActiveTabsCount=n.length;e.Tabs=n;return e};var CheckTurn=function(e){var t=false;var n=e.Tabs;var r=true;var i=0;var s=false;for(var o=0,u=n.length;o<u;o++){if(n[o].ID!==__SE__.ID){i=n[o].Checked!==true?i+1:i;r=r&&n[o].Checked}else{s=n[o].Checked;__SE__.CallsToPass=i;break}}if(i===0&&r===true&&s===false){t=true}return t};var SetTabChecked=function(e){for(var t=0,n=e.Tabs.length;t<n;t++){if(e.Tabs[t].ID===__SE__.ID){e.Tabs[t].Checked=true;break}}return e};var Listeners_Add=function(e){while(__SE__.ListenersStack_ToAdd.length){var t=__SE__.ListenersStack_ToAdd.pop();var n=false;for(var r=0,i=e.SharedEventListeners.length;r<i;r++){var s=e.SharedEventListeners[r];if(JSON.stringify(t)===JSON.stringify(s)){n=true;break}}if(!n){e.SharedEventListeners.push(t)}}return e};var Listeners_Check=function(e){while(__SE__.ListenersStack_ToCheck.length){var t=__SE__.ListenersStack_ToCheck.pop();var n=false;for(var r=0,i=e.SharedEventListeners.length;r<i;r++){var s=e.SharedEventListeners[r];var o=false;var u=s.Type===t.SharedListener.Type;var a=JSON.stringify(s.Listener)===JSON.stringify(t.SharedListener.Listener);var f=s.Target===t.SharedListener.Target;if(!t.SharedListener.Target&&!t.SharedListener.Listener){if(u){o=true}}else if(!t.SharedListener.Target){if(u&&a){o=true}}else if(!t.SharedListener.Listener){if(u&&f){o=true}}else if(t.SharedListener.Target&&t.SharedListener.Listener){if(u&&a&&f){o=true}}if(o){n=true;break}}if(n){t.Callback.call(__SE__,true)}else{t.Callback.call(__SE__,false)}}return e};var Listeners_Remove=function(e){if(!__SE__.ListenersStack_ToRemove.length)return e;var t=[];while(__SE__.ListenersStack_ToRemove.length){var n=__SE__.ListenersStack_ToRemove.pop();var r=n.SharedListener.Type;var i=n.SharedListener.Target;var s=n.SharedListener.Listener;for(var o=0,u=e.SharedEventListeners.length;o<u;o++){var a=e.SharedEventListeners[o];var f=false;var l=r===a.Type?true:false;var c=i===a.Target?true:false;var h=s===a.Listener.toString()?true:false;if(r&&i&&s){f=l&&c&&h?true:false}else if(r&&i){f=l&&c?true:false}else if(r&&s){f=l&&h?true:false}else if(r){f=l?true:false}if(!f){t.push(a)}}n.Callback.call(ROOT,true)}e.SharedEventListeners=t;return e};var Events_Emit=function(e){while(__SE__.EventsStack_ToEmit.length){var t=__SE__.EventsStack_ToEmit.pop();var n=t.Target===__SE__.GID?"Global":"Local";e["EventsEmitted_"+n].push(t)}return e};var Listeners_Run=function(SEData){var CurrentTabName=__SE__.Name;var CurrentListeners={};for(var Key in __SE__.EventListeners){if(Object.prototype.hasOwnProperty.call(__SE__.EventListeners,Key)){CurrentListeners[Key]=__SE__.EventListeners[Key].slice(0)}}var SharedEventListeners=SEData.SharedEventListeners;for(var i=0,l=SharedEventListeners.length;i<l;i++){var SharedListener=SharedEventListeners[i];if(SharedListener.Target===CurrentTabName||SharedListener.Target===__SE__.GID||SharedListener.Target===__SE__.ID){if(CurrentListeners[SharedListener.Type]===undefined){CurrentListeners[SharedListener.Type]=[]}CurrentListeners[SharedListener.Type].push(SharedListener)}}var CurrentEvents=[];for(var i=0,l=SEData.EventsEmitted_Global.length;i<l;i++){if(SEData.EventsEmitted_Global[i].CheckedBy.indexOf(__SE__.ID)===-1){CurrentEvents.push(SEData.EventsEmitted_Global[i]);SEData.EventsEmitted_Global[i].CheckedBy.push(__SE__.ID)}}for(var i=0,l=SEData.EventsEmitted_Local.length;i<l;i++){if(SEData.EventsEmitted_Local[i].CheckedBy.indexOf(__SE__.ID)===-1){SEData.EventsEmitted_Local[i].CheckedBy.push(__SE__.ID);if(SEData.EventsEmitted_Local[i].Target===CurrentTabName){CurrentEvents.push(SEData.EventsEmitted_Local[i])}}}for(var i=0,l=CurrentEvents.length;i<l;i++){var CurrentEventListeners=CurrentListeners[CurrentEvents[i].Type]!==undefined?CurrentListeners[CurrentEvents[i].Type]:false;if(CurrentEventListeners&&CurrentEventListeners instanceof Array){for(var L_i=0,L_l=CurrentEventListeners.length;L_i<L_l;L_i++){var Listener=CurrentEventListeners[L_i];if(typeof Listener==="function"){Listener.call(ROOT,CurrentEvents[i].Data)}else if(typeof Listener==="object"){eval("("+Listener.Listener+")").call(ROOT,CurrentEvents[i].Data)}}}}return SEData};var Events_Clear=function(e){var t=[];for(var n=0,r=e.Tabs.length;n<r;n++){t.push(e.Tabs[n].ID)}var i=function(e,t){var n=[];for(var r=0,i=e.length;r<i;r++){var s=true;for(var o=0,u=t.length;o<u;o++){if(e[r].CheckedBy.indexOf(t[o])===-1){s=false;break}}if(!s){n.push(e[r]);continue}}return n};e.EventsEmitted_Global=i(e.EventsEmitted_Global,t);e.EventsEmitted_Local=i(e.EventsEmitted_Local,t);return e};var Listeners_Clear=function(e){var t=[];for(var n=0,r=e.Tabs.length;n<r;n++){t.push(e.Tabs[n].ID)}var i=[];for(var n=0,r=e.SharedEventListeners.length;n<r;n++){if(t.indexOf(e.SharedEventListeners[n].Sender.ID)!==-1){i.push(e.SharedEventListeners[n])}}e.SharedEventListeners=i;return e};var CheckRevision=function(e){if(e.SE_Revision===undefined||e.SE_Revision!==SE_REVISION){__SE__.clear();e=UnpackSEData()}return e};var UpdateConfig=function(e){var t;t=__SE__.Sync;t=__SE__.TabTimeoutMult;t=__SE__.SLockTimeoutMult;delete t;if(PrivateVars.SharedConfigDeprecated===false){return e}if(PrivateVars.Sync_buffer){__SE__.Sync=PrivateVars.Sync_buffer;PrivateVars.Sync_buffer=false}if(PrivateVars.TabTimeoutMult_buffer){__SE__.TabTimeoutMult=PrivateVars.TabTimeoutMult_buffer;PrivateVars.TabTimeoutMult_buffer=false}if(PrivateVars.SLockTimeoutMult_buffer){__SE__.SLockTimeoutMult=PrivateVars.SLockTimeoutMult_buffer;PrivateVars.SLockTimeoutMult_buffer=false}e.Config.Sync=__SE__.Sync;e.Config.TabTimeoutMult=__SE__.TabTimeoutMult;e.Config.SLockTimeoutMult=__SE__.SLockTimeoutMult;for(var n=0,r=e.Tabs.length;n<r;n++){if(e.Tabs[n].ID===__SE__.ID){e.Tabs[n].ConfigCache.Sync=__SE__.Sync;e.Tabs[n].ConfigCache.TabTimeoutMult=__SE__.TabTimeoutMult;e.Tabs[n].ConfigCache.SLockTimeoutMult=__SE__.SLockTimeoutMult}}PrivateVars.SharedConfigDeprecated=false;return e};var SEWorker=function(){if(--__SE__.CallsToPass>0){return}var e=UnpackSEData();if(e===false)return;e=CheckRevision(e);e=CheckTabs(e);var t=CheckTurn(e);if(t){PrivateVars.RunningNow=true;e=Listeners_Clear(e);e=Listeners_Add(e);e=Listeners_Check(e);e=Listeners_Remove(e);e=Events_Emit(e);e=Listeners_Run(e);e=Events_Clear(e);e=SetTabChecked(e);e=UpdateConfig(e);PrivateVars.RunningNow=false}e.Lock=0;PackSEData(e)};var __SE__={};__SE__.ID=GenerateID();__SE__.GID=undefined;__SE__.Name=undefined;__SE__.SelfExecution=undefined;__SE__.Sync=undefined;__SE__.TabTimeoutMult=undefined;__SE__.SLockTimeoutMult=undefined;__SE__.EventListeners={};__SE__.EventsStack_ToEmit=[];__SE__.ListenersStack_ToAdd=[];__SE__.ListenersStack_ToCheck=[];__SE__.ListenersStack_ToRemove=[];__SE__.ActiveTabsCount=0;__SE__.CallsToPass=0;__SE__.Revision=SE_REVISION;var PrivateVars={};PrivateVars.ID=undefined;PrivateVars.Name=undefined;PrivateVars.RunningNow=true;PrivateVars.SelfExecution=undefined;PrivateVars.SharedConfigDeprecated=false;PrivateVars.Sync=undefined;PrivateVars.Sync_buffer=undefined;PrivateVars.TabTimeoutMult=undefined;PrivateVars.TabTimeoutMult_buffer=undefined;PrivateVars.SLockTimeoutMult=undefined;PrivateVars.SLockTimeoutMult_buffer=undefined;__SE__.clear=function(){localStorage.removeItem(LOCAL_STORAGE_SEDATA_KEY)};__SE__.getActiveTabs=function(){return UnpackSEData(true).Tabs};__SE__.addEventListener=function(e,t,n){CheckType(e);CheckListener(t);if(arguments.length>2){var n=n===false?__SE__.GID:n;CheckTabName(n);var r={Type:e,Target:n,Listener:t.toString(),Sender:{Name:__SE__.Name,ID:__SE__.ID}};__SE__.ListenersStack_ToAdd.push(r)}else{if(__SE__.EventListeners[e]===undefined){__SE__.EventListeners[e]=[]}if(__SE__.EventListeners[e].indexOf(t)===-1){__SE__.EventListeners[e].push(t);return true}else{return false}}};__SE__.hasEventListener=function(e,t,n,r){var n=n||false;var r=r||false;var t=t||false;CheckType(e);if(arguments.length>2){CheckCallback(r);var i={Type:e,Target:n,Listener:t?t.toString():false};var s={SharedListener:i,Callback:r};__SE__.ListenersStack_ToCheck.push(s)}else{if(__SE__.EventListeners[e]===undefined){return false}else if(__SE__.EventListeners[e]!==undefined&&!t){return __SE__.EventListeners[e].length>0?true:false}else{if(__SE__.EventListeners[e].indexOf(t)!==-1){return true}else{return false}}}};__SE__.removeEventListener=function(e,t,n,r){var t=t||false;var n=n||false;CheckType(e);if(arguments.length>2){CheckCallback(r);var i={Type:e,Target:n,Listener:t?t.toString():false};var s={SharedListener:i,Callback:r};__SE__.ListenersStack_ToRemove.push(s)}else{if(__SE__.EventListeners[e]===undefined){return true}else if(__SE__.EventListeners[e]!==undefined&&!t){__SE__.EventListeners[e].length=0;return true}else{var o=__SE__.EventListeners[e].indexOf(t);if(o!==-1){__SE__.EventListeners[e].splice(o,1)}return true}}};__SE__.dispatchEvent=function(e,t,n){var n=n||__SE__.GID;var t=t||false;CheckType(e);CheckTabName(n);var r=CreateEvent(e,t,n);__SE__.EventsStack_ToEmit.push(r)};var SelfExecution_Setter=function(e){PrivateVars.SelfExecution=e?true:false};var SelfExecution_Getter=function(){PrivateVars.SelfExecution=PrivateVars.SelfExecution===undefined?false:PrivateVars.SelfExecution;return PrivateVars.SelfExecution};var Name_Setter=function(e){CheckTabName(e);var t=PrivateVars.Name;PrivateVars.Name=e;if(e!==DEFAULT_TAB_NAME){__SE__.dispatchEvent("tabNameChanged",{Name:e,ID:__SE__.ID,OldName:t},__SE__.GID)}};var Name_Getter=function(){PrivateVars.Name=PrivateVars.Name===undefined?DEFAULT_TAB_NAME:PrivateVars.Name;return PrivateVars.Name};var GID_Setter=function(e){return false};var GID_Getter=function(){return GLOBAL_IDENTIFIER};var Sync_Setter=function(e){if(e===+e&&e===(e|0)){if(PrivateVars.RunningNow){PrivateVars.Sync=parseInt(e,10)}else{PrivateVars.Sync_buffer=parseInt(e,10);PrivateVars.SharedConfigDeprecated=true;return}}else{throw new Error("__SE__: sync value should be an integer. Value was sent: "+e)}if(__SE__.Worker!==undefined){__SE__.Worker.postMessage("suicide")}else{CreateWebWorker()}PrivateVars.SharedConfigDeprecated=true};var Sync_Getter=function(){if(PrivateVars.Sync===undefined){PrivateVars.Sync=DEFAULT_WORKER_INTERVAL}var e=GetConfig();if(e!==false&&e.Sync!==PrivateVars.Sync&&!PrivateVars.SharedConfigDeprecated){__SE__.Sync=e.Sync}return PrivateVars.Sync};var TabTimeoutMult_Setter=function(e){if(e===+e&&e===(e|0)){if(PrivateVars.RunningNow){PrivateVars.TabTimeoutMult=parseInt(e,10)}else{PrivateVars.TabTimeoutMult_buffer=parseInt(e,10);PrivateVars.SharedConfigDeprecated=true;return}}else{throw new Error("__SE__: tab timeout multiplier should be an integer. Multiplier was sent: "+e)}PrivateVars.SharedConfigDeprecated=true};var TabTimeoutMult_Getter=function(){if(PrivateVars.TabTimeoutMult===undefined){PrivateVars.TabTimeoutMult=DEFAULT_TAB_TIMEOUT_MULTIPLIER}var e=GetConfig();if(e!==false&&e.TabTimeoutMult!==PrivateVars.TabTimeoutMult&&!PrivateVars.SharedConfigDeprecated){__SE__.TabTimeoutMult=e.TabTimeoutMult}return PrivateVars.TabTimeoutMult};var SLockTimeoutMult_Setter=function(e){if(e===+e&&e===(e|0)){if(PrivateVars.RunningNow){PrivateVars.SLockTimeoutMult=parseInt(e,10)}else{PrivateVars.SLockTimeoutMult_buffer=parseInt(e,10);PrivateVars.SharedConfigDeprecated=true;return}}else{throw new Error("__SE__: storage lock timeout multiplier should be an integer. Multiplier was sent: "+e)}PrivateVars.SharedConfigDeprecated=true};var SLockTimeoutMult_Getter=function(){if(PrivateVars.SLockTimeoutMult===undefined){PrivateVars.SLockTimeoutMult=DEFAULT_STORAGE_LOCK_MULTIPLIER}var e=GetConfig();if(e!==false&&e.SLockTimeoutMult!==PrivateVars.SLockTimeoutMult&&!PrivateVars.SharedConfigDeprecated){__SE__.SLockTimeoutMult=e.SLockTimeoutMult}return PrivateVars.SLockTimeoutMult};var ID_Setter=function(e){if(PrivateVars.ID===undefined){PrivateVars.ID=e}return PrivateVars.ID?PrivateVars.ID:__SE__.ID};var ID_Getter=function(){if(PrivateVars.ID===undefined){PrivateVars.ID=GenerateID()}return PrivateVars.ID};Object.defineProperty(__SE__,"GID",{set:GID_Setter,get:GID_Getter});Object.defineProperty(__SE__,"ID",{set:ID_Setter,get:ID_Getter});Object.defineProperty(__SE__,"Name",{set:Name_Setter,get:Name_Getter});Object.defineProperty(__SE__,"SelfExecution",{set:SelfExecution_Setter,get:SelfExecution_Getter});Object.defineProperty(__SE__,"SLockTimeoutMult",{set:SLockTimeoutMult_Setter,get:SLockTimeoutMult_Getter});Object.defineProperty(__SE__,"Sync",{set:Sync_Setter,get:Sync_Getter});Object.defineProperty(__SE__,"TabTimeoutMult",{set:TabTimeoutMult_Setter,get:TabTimeoutMult_Getter});__SE__.Sync=__SE__.Sync;ROOT.__SE__=__SE__}).call(window)